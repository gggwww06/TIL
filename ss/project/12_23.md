### 목차

> [1. Mysql 프로시저 작성](#1-mysql-프로시저-작성)
>

# 1. Mysql 프로시저 작성

### 저장 프로시저 (Stored Procedure)

- 일련의 SQL 문장을 선언해서 MySQL에 저장하고, **해당 SQL문을 함수처럼 사용하는 것**으로 만들어 두기만 하면 함수처럼 호출하여 편하게 사용할 수 있다.

### 왜 저장 프로시저를 사용하는가?

- 저장 프로시저는 사용자들에게 데이터에 대한 **제한적인 접근**을 허용케 하는 전통적인 수단이다.

- 쿼리 분석가와 같은 도구를 이용할 경우 원하는 어떠한 작업도 수행가능하므로, **사용자들은 SELECT, INSERT, UPDATE 혹은 DELETE 같은 문장을 직접 실행할 수 있는 권한을 가져서는 안된다.**

- **성능을 향상**시키기 위해서이다. 저장 프로시저가 최초로 실행되면, SQL 서버는 해당 프로시저에 대한 실행계획을 생성, 이 **실행계획이 캐쉬에 저장**된다.

- 해당 저장 프로시저가 재실행 요청을 받으면, SQL 서버는 저장된 실행계획을 재사용. 실행계획이 만료되거나 SQL 서버가 새로운 실행계획을 생성시켜야 할 이유가 생길 때까지 해당 실행계획은 캐쉬에 유지

- 50줄 이사의 복잡한 Select 문장이 있으며, 각 실행시마다 Where 절 조건문이 조금씩 변한다고 가정해보자. 이 문장을 저장 프로시저에 넣을 경우, **네트워크를 통해 전달되는 데이터 소통량이 상당히 감소**하게 되며, **해당 프로시저가 자주 실행될 수록 성능향상 효과가 증대** 된다.

- 단일 행을 반환하는 SQL 문장을 실행시키고 싶을 경우에, SQL 문만 사용하면 결과 집합(record set)을 레코드셋으로 반환받아야 한다. 하지만, 저장 프로시저를 사용할 경우에는 **성능이 월등한 출력매개변수의 사용이 가능**하다.

- 단일 쿼리에 대한 실행시간의 차이는 무시할 수 있겠지만, 신규 사용자 등록 같은 단순 insert 작업을 SQL 서버에 **수만 번 해야 한다면**, 결과 집합으로 값을 받는 것에 비해 @key를 출력 매개변수로 반환받는 경우의 이점은 엄청나게 커지게 된다.

- 수백 개의 테이블이 존재하는 복잡한 시스템에서, 간혹 어디에서 어떤 테이블 혹은 칼럼이 참조되었는지 알고 싶을 때, 참조된 개체를 찾기 위해 저장 프로시저의 코드만 살펴보면 된다. (SQL문을 직접 사용하는 경우 흩어져 있는 더 많은 코드를 살펴봐야 할 수 있다.)

### mysql 설치

- 8.04 설치

- 현재 LTS 버전인 8.4는 workbrench가 제공되지 않음

### 테이블 생성
```sql
CREATE TABLE `user`(
  `id` varchar(20),
  `name` varchar(20),
  `campus` varchar(10),
  `class` varchar(10),
  `gi` varchar(10)
);
```

- 백틱(`) : 명령어와 구분하기 위해 사용

### 저장 프로시저 작성
```sql
DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `proc_user_insert`(
  `p_id` varchar(20),
  `p_name` varchar(20),
  `p_campus` varchar(10),
  `p_class` varchar(10),
  `p_gi` varchar(10)
)
BEGIN
	INSERT INTO ssafy_user(id, name, campus, class, gi)
    VALUES (p_id, p_name, p_campus, p_class, p_gi);
END$$
DELIMITER ;
```

- `DELIMITER` : 구분자를 변경

- 구분자를 변경하지 않으면 기본 구분자인 세미콜론(;)을 명령 종료로 잘못 인식해 오류가 발생할 수 있다. 블록 작성 시 구분자를 변경하고 블록이 끝난 후 다시 세미콜론으로 되돌린다. 

### 호출 쿼리
```sql
use name_schema;

CALL proc_user_insert ('id_123', '홍길동', '서울', '1반', '1기');

SELECT * FROM ssafy_user;
```
